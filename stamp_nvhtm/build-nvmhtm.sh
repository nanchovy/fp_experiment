#!/bin/bash

THIS_FOLDER=`pwd`
NVMHTM_FOLDER=~/projects/nvmhtm
MIN_NVM_LIB_DIR=~/projects/minimal_nvm
NVM_LIB_DIR=~/nvml-1.2
COMMON_FLAGS="-DCMAKE_BUILD_TYPE=\"Prod\" -DUSE_MIN_NVM=1 -G \"Unix Makefiles\" -DNVM_DIR=$NVM_LIB_DIR -DMIN_NVM_DIR=$MIN_NVM_LIB_DIR"

BUILD_SCRIPT=./build-stamp.sh

# make avni solution
rm -rf $NVMHTM_FOLDER/build
mkdir  $NVMHTM_FOLDER/build
cd $NVMHTM_FOLDER

if [ $1 == avni ] ; then
	./compile.sh avni 0 0
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="AVNI_SOL=-DAVNI_SOL=1 DISABLE_FLUSH=-DDISABLE_FLUSH=1 DISABLE_DRAIN=-DDISABLE_DRAIN=1"
	$BUILD_SCRIPT htm-sgl-nvm $2 
elif [ $1 == htm_only ] ; then
	./compile.sh htm 0 0
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="HTM_ONLY=-DHTM_ONLY=1 DISABLE_FLUSH=-DDISABLE_FLUSH=1"
	$BUILD_SCRIPT htm-sgl-nvm $2 "-DUSE_MIN_NVM=1 -DHTM_ONLY=1 -DDISABLE_FLUSH=1"
elif [ $1 == normal_no_val ] ; then
	./compile.sh redo 0 0
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="DISABLE_VALIDATION=-DDISABLE_VALIDATION=1 DISABLE_FLUSH=-DDISABLE_FLUSH=1 DISABLE_DRAIN=-DDISABLE_DRAIN=1"
	$BUILD_SCRIPT htm-sgl-nvm $2 
elif [ $1 == normal_no_val_no_cnt ] ; then
	./compile.sh redo 0 0
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="DISABLE_VALIDATION=-DDISABLE_VALIDATION=1 DISABLE_FLUSH=-DDISABLE_FLUSH=1 DISABLE_DRAIN=-DDISABLE_DRAIN=1 DISABLE_CNT_COMMIT=-DDISABLE_CNT_COMMIT=1"
	$BUILD_SCRIPT htm-sgl-nvm $2 
elif [ $1 == val_2 ] ; then
	./compile.sh redo 2 0
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="DISABLE_FLUSH=-DDISABLE_FLUSH=1 DISABLE_DRAIN=-DDISABLE_DRAIN=1 VALIDATION_2=-DVALIDATION=2"
	$BUILD_SCRIPT htm-sgl-nvm $2
elif [ $1 == val_3 ] ; then
	./compile.sh redo 3 0
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="DISABLE_FLUSH=-DDISABLE_FLUSH=1 DISABLE_DRAIN=-DDISABLE_DRAIN=1 VALIDATION_2=-DVALIDATION=3"
	$BUILD_SCRIPT htm-sgl-nvm $2 
elif [ $1 == ch_p_val_3 ] ; then
	./compile.sh redo 3 1 $3
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="DISABLE_FLUSH=-DDISABLE_FLUSH=1 DISABLE_DRAIN=-DDISABLE_DRAIN=1 VALIDATION_2=-DVALIDATION=3 DO_CHECKPOINT=-DDO_CHECKPOINT=1 NVMHTM_LOG_SIZE=-DNVMHTM_LOG_SIZE=$3"
	$BUILD_SCRIPT htm-sgl-nvm $2
elif [ $1 == ch_p_val_2 ] ; then
	./compile.sh redo 2 1 $3
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="DISABLE_FLUSH=-DDISABLE_FLUSH=1 DISABLE_DRAIN=-DDISABLE_DRAIN=1 VALIDATION_2=-DVALIDATION=2 DO_CHECKPOINT=-DDO_CHECKPOINT=1 NVMHTM_LOG_SIZE=-DNVMHTM_LOG_SIZE=$3"
	$BUILD_SCRIPT htm-sgl-nvm $2
elif [ $1 == ch_r_val_3 ] ; then
	./compile.sh redo 3 2 $3
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="DISABLE_FLUSH=-DDISABLE_FLUSH=1 DISABLE_DRAIN=-DDISABLE_DRAIN=1 VALIDATION_2=-DVALIDATION=3 DO_CHECKPOINT=-DDO_CHECKPOINT=2 NVMHTM_LOG_SIZE=-DNVMHTM_LOG_SIZE=$3"
	$BUILD_SCRIPT htm-sgl-nvm $2
elif [ $1 == ch_r_val_2 ] ; then
	./compile.sh redo 2 2 $3
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="DISABLE_FLUSH=-DDISABLE_FLUSH=1 DISABLE_DRAIN=-DDISABLE_DRAIN=1 VALIDATION_2=-DVALIDATION=2 DO_CHECKPOINT=-DDO_CHECKPOINT=2 NVMHTM_LOG_SIZE=-DNVMHTM_LOG_SIZE=$3"
	$BUILD_SCRIPT htm-sgl-nvm $2
else
	./compile.sh redo 3 1
	
	cd $THIS_FOLDER
	export MAKEFILE_ARGS="DISABLE_FLUSH=-DDISABLE_FLUSH=1 DISABLE_DRAIN=-DDISABLE_DRAIN=1"
	$BUILD_SCRIPT htm-sgl-nvm $2 
fi
